# แผนพัฒนาระบบ LINE Bot แจ้งเตือนเหตุการณ์ (ฉบับสมบูรณ์)

เอกสารนี้คือแนวทางการพัฒนาระบบ LINE Bot สำหรับการแจ้งเตือนเหตุการณ์ โดยรวบรวมฟีเจอร์, เทคโนโลยีที่ใช้, และแผนการดำเนินงานทั้งหมด **(อัปเดตล่าสุด: 7 ส.ค. 2568)**

---

## 1. สรุปภาพรวมและเป้าหมาย (Project Overview)

พัฒนาระบบ LINE Bot สำหรับเป็นช่องทางสื่อสารและแจ้งข่าวสาร/เหตุการณ์สำคัญต่างๆ โดยมีกลุ่มผู้ใช้ 2 กลุ่มหลัก:

1.  **ผู้ใช้ทั่วไป (User):** สามารถสอบถามข้อมูลเหตุการณ์ล่าสุด, ค้นหาเหตุการณ์ที่สนใจ, และรับการแจ้งเตือนเหตุการณ์ล่วงหน้าได้
2.  **แอดมิน (Admin):** สามารถเพิ่ม, แก้ไข, และลบข้อมูลเหตุการณ์ผ่านคำสั่งใน LINE ได้อย่างสะดวก

**เป้าหมายหลัก:** สร้างบอทที่ใช้งานง่าย, ตอบสนองรวดเร็ว, และลดภาระการตอบคำถามซ้ำๆ ของแอดมิน

---

## 2. เทคโนโลยีที่ใช้ (Technology Stack) - ฉบับปัจจุบัน

| ส่วนประกอบ | เทคโนโลยี | หมายเหตุ |
| :--- | :--- | :--- |
| **LINE Bot** | LINE Messaging API | - |
| **Backend** | Python + Flask | - |
| **Database** | Supabase (PostgreSQL) | - |
| **Deployment** | **Render.com** | เปลี่ยนจากแผนเดิม (Heroku) เพื่อความเสถียร |
| **Authentication** | ตรวจสอบสิทธิ์แอดมินจาก LINE User ID | - |
| **Scheduled Jobs**| **Render Cron Job** | สำหรับส่งการแจ้งเตือนตามกำหนดเวลา |
| **Monitoring** | Uptime Robot | ป้องกันไม่ให้แอป Sleep และตรวจสอบสถานะ |

---

## 3. โครงสร้างฐานข้อมูล (Database Schema)

*โครงสร้างยังคงเดิมตามแผนที่วางไว้*

**ตารางที่ 1: `events`**

| ชื่อคอลัมน์ | ประเภทข้อมูล | คำอธิบาย |
| :--- | :--- | :--- |
| `id` | `bigint` (Primary Key) | รหัสเฉพาะของเหตุการณ์ (auto-increment) |
| `created_at` | `timestamp with time zone` | วันเวลาที่สร้าง (default: `now()`) |
| `event_title` | `text` | ชื่อหัวข้อของเหตุการณ์ (สำหรับค้นหา) |
| `event_description` | `text` | รายละเอียดเพิ่มเติม |
| `event_date` | `date` | วันที่เกิดเหตุการณ์ |
| `created_by` | `text` | LINE User ID ของแอดมินที่เพิ่มข้อมูล |

**ตารางที่ 2: `subscribers`**

| ชื่อคอลัมน์ | ประเภทข้อมูล | คำอธิบาย |
| :--- | :--- | :--- |
| `user_id` | `text` (Primary Key) | LINE User ID ของผู้ใช้ที่ติดตาม |
| `subscribed_at` | `timestamp with time zone` | วันเวลาที่เริ่มติดตาม |

---

## 4. แผนการพัฒนา (Development Roadmap) - สถานะ: เสร็จสมบูรณ์

### **Phase 1: การตั้งค่าพื้นฐานและโครงสร้าง (Foundation & Setup)**
- [x] สร้างโฟลเดอร์โปรเจกต์และตั้งค่า Virtual Environment (`venv`)
- [x] สร้างไฟล์ `requirements.txt` และติดตั้ง Library ที่จำเป็น (Flask, line-bot-sdk, supabase-py, etc.)
- [x] สร้างตาราง `events` และ `subscribers` บน Supabase
- [x] สร้างไฟล์หลัก `app.py` สำหรับ Flask และเชื่อมต่อ LINE Webhook เบื้องต้น
- [x] ตั้งค่า Environment Variables สำหรับเก็บ Keys (LINE Secret, Supabase URL/Key)

### **Phase 2: พัฒนาฟังก์ชันสำหรับแอดมิน (Admin Features)**
- [x] เขียนฟังก์ชันตรวจสอบสิทธิ์แอดมินจาก `userId` ที่กำหนดไว้
- [x] พัฒนาคำสั่งสำหรับ "เพิ่มเหตุการณ์" (`/add <ชื่อเรื่อง> <รายละเอียด> <วันที่>`)
- [x] พัฒนาคำสั่งสำหรับ "ลบเหตุการณ์" และ "แก้ไขเหตุการณ์"

### **Phase 3: พัฒนาฟังก์ชันสำหรับผู้ใช้ (User Features)**
- [x] พัฒนาคำสั่งให้ผู้ใช้ "สอบถามเหตุการณ์ล่าสุด" (เช่น พิมพ์ "ล่าสุด")
- [x] พัฒนาฟังก์ชันค้นหาเหตุการณ์จาก Keyword (2-3 คำ)
- [x] **(สำคัญ)** ออกแบบและนำ LINE Flex Message มาใช้ในการแสดงผลลัพธ์ให้สวยงาม

### **Phase 4: พัฒนาระบบแจ้งเตือน (Notification System)**
- [x] สร้างคำสั่งให้ผู้ใช้ "ติดตาม" (`/subscribe`) และ "เลิกติดตาม" (`/unsubscribe`)
- [x] สร้างสคริปต์ `scheduler.py` แยกต่างหากสำหรับส่งการแจ้งเตือนล่วงหน้า
- [x] ติดตั้ง **Render Cron Job** และตั้งค่า Job ให้รันคำสั่ง `python scheduler.py` ตามเวลาที่กำหนด

### **Phase 5: การ Deploy และดูแลรักษา (Deployment & Maintenance)**
- [x] สร้าง `Procfile` เพื่อให้ Render รู้จักแอปพลิเคชันของเรา
- [x] Deploy โค้ดทั้งหมดขึ้น **Render.com**
- [x] ตั้งค่า Webhook URL ใน LINE Developers Console ให้ชี้ไปที่ Render App
- [x] **(สำคัญ)** ตั้งค่าบริการ Ping (UptimeRobot) และสร้าง Health Check Endpoint (`/`) เพื่อป้องกันแอป Sleep
- [x] ทดสอบการใช้งานจริงทุกฟีเจอร์และแก้ไขข้อบกพร่องทั้งหมด

---

## 5. ฟีเจอร์เพิ่มเติมในอนาคต (Future Enhancements)

*ยังคงเดิมตามแผน*

---

## 6. บันทึกการพัฒนาและความคืบหน้า (Development Log)

ส่วนนี้คือบันทึกการทำงานและการปรับปรุงที่เกิดขึ้นจริงในโปรเจกต์

*   **การตั้งค่าโปรเจกต์:** เริ่มต้นโปรเจกต์, ติดตั้ง Dependencies, และเตรียมไฟล์โครงสร้าง (`app.py`, `requirements.txt`, `.env.example`, `Procfile`)
*   **การตั้งค่าฐานข้อมูล:** สร้างตาราง `events` และ `subscribers` บน Supabase สำเร็จ
*   **การ Deploy ครั้งแรก:** นำโค้ดทั้งหมดขึ้น GitHub และ Deploy Web Service (`app.py`) และ Cron Job (`scheduler.py`) บน Render.com สำเร็จ
*   **การแก้ปัญหา:**
    *   แก้ไขปัญหาการเชื่อมต่อ Supabase ที่เกิดจากการตั้งค่า Environment Variables ไม่ถูกต้อง
    *   แก้ไขปัญหาการเข้าถึงตารางที่ถูกป้องกันโดย Row Level Security (RLS) ของ Supabase
*   **ยกเครื่อง UX/UI ครั้งที่ 1:**
    *   ออกแบบและนำ **Flex Message** มาใช้เพื่อแสดงผลข้อมูลกิจกรรมให้สวยงามและทันสมัย
    *   เพิ่ม **Quick Reply** (ปุ่มกด) เพื่อแนะนำคำสั่งที่ใช้บ่อย (`ล่าสุด`, `วันนี้`, `ยกเลิกติดตาม`)
    *   เพิ่มคำสั่งใหม่สำหรับผู้ใช้: `/help`, `/settings`, `/today`, `/next`
    *   เพิ่มข้อความต้อนรับ (Follow Event) ที่เป็นมิตรและแนะนำการใช้งานเบื้องต้น
    *   ปรับปรุงข้อความตอบกลับทั้งหมดให้สุภาพและเข้าใจง่ายขึ้น
*   **ยกเครื่องระบบแอดมิน:**
    *   เพิ่ม "โหมดแอดมิน" ที่เข้าถึงได้ด้วยคำสั่ง `/admin`
    *   สร้าง Quick Reply แยกสำหรับแอดมินโดยเฉพาะ เพื่อความรวดเร็วในการจัดการ
    *   เพิ่มคำสั่ง `/stats subscribers` เพื่อให้แอดมินตรวจสอบจำนวนผู้ติดตามได้
    *   **ยกเครื่องการลบ:** เปลี่ยนจากการพิมพ์คำสั่ง `/delete <ID>` มาเป็นการ **กดปุ่ม "ลบ" ที่การ์ดกิจกรรมได้โดยตรง** เพื่อลดความผิดพลาดและเพิ่มความสะดวก
    *   **ยกเครื่องการเพิ่ม:** ปรับปรุง Logic ของคำสั่ง `/add` ให้สามารถรองรับรายละเอียดกิจกรรมที่ยาวและมีเว้นวรรคซับซ้อนได้โดยไม่เกิดข้อผิดพลาด
*   **เพิ่มฟีเจอร์แจ้งเตือนทันที:**
    *   อัปเกรดคำสั่ง `/add` ให้มีความสามารถในการ **Broadcast แจ้งเตือนกิจกรรมใหม่ไปยังผู้ติดตามทุกคนได้ทันที** หลังจากที่แอดมินเพิ่มกิจกรรมสำเร็จ
*   **การดูแลรักษาระบบ:**
    *   ตั้งค่า Uptime Robot เพื่อป้องกันไม่ให้แอป Sleep
    *   เพิ่ม Health Check Endpoint (`/`) ใน `app.py` เพื่อให้ Uptime Robot ตรวจสอบสถานะได้อย่างถูกต้อง
*   **การแก้ไข Bug:**
    *   แก้ไข Bug การตรวจสอบสิทธิ์แอดมินที่เกิดจาก Whitespace
    *   แก้ไข Bug ที่ Logic ของแอดมินและผู้ใช้ทำงานทับซ้อนกัน ทำให้แอดมินไม่สามารถใช้คำสั่งทั่วไปได้
    *   แก้ไข Bug การยืนยันผลลบข้อมูลจาก Supabase ที่ทำให้เกิด `TypeError`
    *   แก้ไข Bug การแสดง Quick Reply ที่ทำให้แสดงผลตลอดเวลาและสร้างความรำคาญ

**สถานะปัจจุบัน:** ระบบทำงานได้อย่างสมบูรณ์และเสถียรตามฟังก์ชันที่ออกแบบไว้ทั้งหมด